import{isPlainObject as u,isRedirect as E,isNotFound as C}from"@tanstack/react-router";import $ from"tiny-invariant";import{AsyncLocalStorage as q}from"node:async_hooks";import{H3Event as w,getRequestURL as j,getResponseStatus as H,getHeaders as D,getRequestWebStream as L,eventHandler as N}from"h3";import{getContext as z}from"unctx";const f={stringify:e=>JSON.stringify(e,function(t,r){const o=this[t],c=l.find(a=>a.stringifyCondition(o));return c?c.stringify(o):r}),parse:e=>JSON.parse(e,function(t,r){const o=this[t];if(u(o)){const c=l.find(a=>a.parseCondition(o));if(c)return c.parse(o)}return r}),encode:e=>{if(Array.isArray(e))return e.map(t=>f.encode(t));if(u(e))return Object.fromEntries(Object.entries(e).map(([t,r])=>[t,f.encode(r)]));const n=l.find(t=>t.stringifyCondition(e));return n?n.stringify(e):e},decode:e=>{if(u(e)){const n=l.find(t=>t.parseCondition(e));if(n)return n.parse(e)}return Array.isArray(e)?e.map(n=>f.decode(n)):u(e)?Object.fromEntries(Object.entries(e).map(([n,t])=>[n,f.decode(t)])):e}},p=(e,n,t,r)=>({key:e,stringifyCondition:n,stringify:o=>({[`$${e}`]:t(o)}),parseCondition:o=>Object.hasOwn(o,`$${e}`),parse:o=>r(o[`$${e}`])}),l=[p("undefined",e=>e===void 0,()=>0,()=>{}),p("date",e=>e instanceof Date,e=>e.toISOString(),e=>new Date(e)),p("error",e=>e instanceof Error,e=>({...e,message:e.message,stack:void 0,cause:e.cause}),e=>Object.assign(new Error(e.message),e)),p("formData",e=>e instanceof FormData,e=>{const n={};return e.forEach((t,r)=>{const o=n[r];o!==void 0?Array.isArray(o)?o.push(t):n[r]=[o,t]:n[r]=t}),n},e=>{const n=new FormData;return Object.entries(e).forEach(([t,r])=>{Array.isArray(r)?r.forEach(o=>n.append(t,o)):n.append(t,r)}),n})];function M(e){let n;const t=O(e),r={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(t,{...r,body:e.node.req.body}):new Request(t,{...r,get body(){return n||(n=B(e),n)}})}function P(e){return e.web??(e.web={request:M(e),url:O(e)}),e.web.request}function I(){return v()}const T=Symbol("$HTTPEvent");function W(e){return typeof e=="object"&&(e instanceof w||e?.[T]instanceof w||e?.__is_event__===!0)}function h(e){return function(...n){var t;let r=n[0];if(W(r))n[0]=r instanceof w||r.__is_event__?r:r[T];else{if(!((t=globalThis.app.config.server.experimental)!=null&&t.asyncContext))throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(r=I(),!r)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");n.unshift(r)}return e(...n)}}const O=h(j),J=h(H),U=h(D),B=h(L);function V(){var e;return z("nitro-app",{asyncContext:!!((e=globalThis.app.config.server.experimental)!=null&&e.asyncContext),AsyncLocalStorage:q})}function v(){return V().use().event}const G={},te=N(K),g=G;async function K(e){const n=P(e),t=await X(n);return Object.entries(U()).forEach(([r,o])=>{r&&o&&(!t.headers.has(r)||!t.headers.get(r))&&r.toLowerCase()!=="content-length"&&t.headers.set(r,o)}),t}function Q(e){return e.replace(/^\/|\/$/g,"")}async function X(e,n){const t=e.method,r=new URL(e.url,"http://localhost:3000"),o=new RegExp(`${Q("/_server")}/([^/?#]+)`),c=r.pathname.match(o),a=c?c[1]:null,R=Object.fromEntries(r.searchParams.entries());if(typeof a!="string")throw new Error("Invalid server action param for serverFnId: "+a);const m=g[a];if(!m)throw console.log("serverFnManifest",g),new Error("Server function info not found for "+a);let d;if(d=await m.importer(),!d)throw console.log("serverFnManifest",g),new Error("Server function module not resolved for "+a);const S=d[m.functionName];if(!S)throw console.log("serverFnManifest",g),console.log("fnModule",d),new Error(`Server function module export not resolved for serverFn ID: ${a}`);const A=["multipart/form-data","application/x-www-form-urlencoded"],y=await(async()=>{try{const s=await(async()=>{if(e.headers.get("Content-Type")&&A.some(_=>{var b;return(b=e.headers.get("Content-Type"))==null?void 0:b.includes(_)}))return $(t.toLowerCase()!=="get","GET requests with FormData payloads are not supported"),await e.formData();if(t.toLowerCase()==="get")return R.payload?f.parse(R.payload):void 0;const F=await e.text();return f.parse(F)})(),i=await S(s);return i instanceof Response?i:u(i)&&"result"in i&&i.result instanceof Response?i.result:E(i)||C(i)?x(i):new Response(i!==void 0?f.stringify(i):void 0,{status:J(v()),headers:{"Content-Type":"application/json"}})}catch(s){return s instanceof Response?s:u(s)&&"result"in s&&s.result instanceof Response?s.result:E(s)||C(s)?x(s):(console.error("Server Fn Error!"),console.error(s),console.info(),new Response(f.stringify(s),{status:500,headers:{"Content-Type":"application/json"}}))}})();if(y.headers.get("Content-Type")==="application/json"){const i=await y.clone().text();i&&JSON.stringify(JSON.parse(i))}return y}function x(e){const{headers:n,...t}=e;return new Response(JSON.stringify(t),{status:200,headers:{"Content-Type":"application/json",...n||{}}})}export{te as default};
